\documentclass{article}
\usepackage{hyperref}
\newcommand{\code}{{\texttt{QuickFiber}}}
\title{Documentation for \code\ Input and Output Files}
\author{Jaime E. Forero-Romero}

\begin{document}
\maketitle
\tableofcontents 

\vspace{1cm}
This documents describes the format of the files generated by the
\code\ software.  

\section{Important definitions}
Taken from \url{https://desi.lbl.gov/trac/wiki/Pipeline/FormatsAndNumbering}
\begin{itemize}

  \item Tile: pre-defined locations on the sky. Tiles are pre-defined
    with a 6-digit ID. 900000 and above are reserved for calibration,
    commissioning, test, ancillary, and other non-DESI key project
    tiles, which may not even appear in a DESI tile list.  
  \item Pointing: A specific
    selection of targets within a tile indicating both a pointing of the
    telescope and the fiber positioners.  
\end{itemize}

This means that a tile may be observed
multiple times with different pointings. A pointing may be observed
multiple times with different exposures. If even one target changes
or any target: fiber mapping changes it becomes a new pointing. A
slightly different positioner location of the same targets on the
same fibers is the same pointing.  

\section{\code\ inputs}
The necessary input of \code\ are 
\begin{itemize}
\item TargetDB. Data base containing the information of all targets on the sky. 
\item SurveyTiles. File containing the positions of all the tiles to
  be observed. Currently this ASCII file
  \url{https://desi.lbl.gov/trac/browser/code/survey/surveyplan/trunk/data/desi-tiles-full.par} 
\item FiberPositions. File containing the positions of all fibers on
  the focal plane.  Currently this ASCII file \url{https://desi.lbl.gov/trac/browser/code/desimodel/trunk/data/focalplane/fiberpos.txt}
\end{itemize}



\section{\code\ inputs data-structure}


In the TargetDB found in \texttt{/project/projectdirs/desi/db} the
table of interest is \texttt{Target} with the following columns

\begin{itemize}
\item brickid: [1,662174]
\item objid: [0,N-1]
\item brick\_primary: T, F
\item ra: degrees [0-360]
\item dec: degrees [-90 -+90]
\item objtype: ELG, LRG, QSO, SKY, STDSTAR, GAL, OTHER
\end{itemize}

\noindent
SurveyTiles is a FITS file with the following fields.
\begin{itemize}
\item ...
\end{itemize}

FiberPositions is a FITS file with the following fields.
\begin{itemize}
\item ...
\end{itemize}



\section{\code\ outputs}

The principal outputs of \code\ are
\begin{itemize}
\item PotentialFiberMap. The set of targets that can be reached by a
  set of fibers in a  tile.  
\item FiberMap. This is a pointing defining which targets are on which
  fiber.
\end{itemize}

The previous two items will be stored in the same FITS file for each
tile and poiting. This means that two different assignment algorithms
running on the same tile producing different pointings will store
the results in different files. 

\section{\code\ output file naming convention}

Primary output files from \code\ will follow the naming scheme

\begin{center}
\code\_{\texttt{TTTTTT}}\_{\texttt{PPPPPPPPPPPP.fits}}
\end{center}
\noindent
where \texttt{TTTTTT} is the 6-digit Tile ID and \texttt{PPPPPPPPPPPP} is
a 12-digit pointing ID. The pointing ID is hash value computed by
adding the IDs of all the targets in the pointing. 

\section{\code\ outputs data-structure}


PotentialFiberMap contains the following information
\begin{itemize}
\item fiber: [0-4999]
\item numtargetid: [1-] Number of potential target IDs associated to each
  fiber. If a fiber has zero potential targets it has the
  targetID \texttt{-1} associated to it. 
\item targetid:  unique target identifier to get back to target
      selection info. This contains  all the targets that can be
      reached by a fiber. This concatenates the sets of available
      targets for each fiber.
\end{itemize}

\noindent
FiberMap contains the following information\footnote{First defined in
  \url{https://desi.lbl.gov/trac/wiki/Pipeline/FormatsAndNumbering}.} 
\begin{itemize}
    \item fiber: [0-4999]
    \item positioner: [0-4999]
    \item objtype: ELG, LRG, QSO, SKY, STDSTAR, GAL, OTHER
    \item targetid: 
      unique target identifier to get back to target
      selection info 
    \item desi\_target0: 64 bit mask of targeting info 
    \item ra: degrees [0-360] 
    \item dec: degrees [-90 - +90] 
    \item xfocal\_design: mm from center in positioner coordinate system 
    \item yfocal\_deisgn: mm from center in positioner coordinate system  
\end{itemize}



\subsection{Example of PotentialFiberMap construction}
Let's assume for simplicity that we have 4 fibers with IDs
\texttt{[0,1,2,3]}. There are in turn 4 differents sets of targets that
can be reached by each fiber. These sets are \texttt{[980,203]},
\texttt{[736,102,304]}, \texttt{[234]} and \texttt{[-1]} for fibers
\texttt{0,1,2} and \texttt{3}, respectiveley.
The index \texttt{-1} for fiber \texttt{3} means that this fiber
cannot reach any target.

In this case PotentialFiberMap has the following fields
\begin{itemize}
\item
fiber: contains the array \texttt{[0,1,2,3]}.
\item
numtargetid: contains the array \texttt{[2,3,1,1]}.
\item
targetid: contains the array \texttt{[980,203,736,102,304,234,-1]}.

\end{itemize}





\end{document}
